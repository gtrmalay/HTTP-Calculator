# Распределенный вычислитель арифметических выражений HTTP-Calculator

## О проекте
Этот проект представляет собой систему для параллельного вычисления арифметических выражений в распределённой среде. Агент отвечает за выполнение вычислений: он запускает заданное количество воркеров, которые обрабатывают отдельные бинарные выражения, входящие в состав общего выражения, работая одновременно.

## Структура проекта
```
cmd/
  ├── agent/
  │   └── main.go
  ├── calculator/
  │   └── main.go
internal/
  ├── agent/
  │   └── agent_test.go
  │   └── agent.go
  ├── handlers/
  │   └── handlers_test.go
  │   └── handlers.go
  ├── models/
  │   ├── models.go
  ├── storage/
  │   ├── storage.go
go.mod
go.sum
LICENSE.txt
README.md
```


## Установка и запуск проекта
### Установка
1. Клонируйте репозиторий
```sh
git clone https://github.com/gtrmalay/HTTP-Calculator.git
```
2. Перейдите в директорию проекта
```sh
cd .\HTTP-Calculator\
```
3. Установите зависимости
```sh
go mod tidy
```
### Запуск

1. **Запустите оркестратор:**
```sh
go run ./cmd/calculator/main.go
```
2. **Запустите агента:**
```sh
go run ./cmd/agent/main.go
```
В программе используются переменные среды, чтобы указать время выполнения операций, необходимо перед командой запуска программы в консоли указать значение переменной среды

Пример:
```sh
TIME_ADDITION_MS=1000 TIME_SUBTRACTION_MS=1000 TIME_MULTIPLICATION_MS=2000 TIME_DIVISION_MS=2000 go run ./cmd/calculator/main.go
```
Чтобы указать количество горутин для вычисления задач тоже указывается значение переменной среды

Пример:
```sh
COMPUTING_POWER=3 go run ./cmd/agent/main.go
```

**Примечение:** если не указать определенные значения, то программа установит default значения по умолчанию

## Документация
### Оркестратор
Когда пользователь отправляет выражение на сервер, программа строит его представление в обратной польской нотации и возвращает ID выражения (если в выражении есть ошибка, вместо ID возвращается сообщение об ошибке). Выражение добавляется в список тасков со статусом "in pending", и начинается его вычисление.

Процесс расчёта устроен так: программа строит хеш-таблицу(map) на основе обратной польской нотации для дальнейшей работы. Затем она проходит по выражению, находит операнды и операторы, которые могут быть вычислены, и отправляет их в список задач (tasks) и POST-запросом отправляет json-задачу на сервер на энд-поинт /internal/task. Когда агент обращается к серверу, он получает задачу из списка посредством GET-запроса с сервера по энд-поинту /internal/task). После того как агент выполнит вычисления, он формирует результат в виде JSON-объекта и отправляет его на сервер с помощью POST-запроса на энд-поинт /internal/task. Сервер, в свою очередь, получает этот результат и обновляет состояние задачи в хеш-таблице, отмечая её как завершённую.
Если задача имеет зависимость от других задач, сервер должен отслеживать, какие задачи завершены, и только когда все зависимости будут выполнены, задача будет считаться готовой для выполнения. Для этого можно используются дополнительные поля в JSON-объекте задачи, которые будут содержать информацию о зависимостях и их текущем статусе.
### Агент
При старте агент запускает несколько горутин, количество которых определяется переменной среды (COMPUTING_POWER) при запуске (если не была указана, default значение "1", т.е. одна горутина), каждая из которых с небольшим интервалом отправляет GET-запрос на сервер для получения задачи. Если задача успешно получена, горутина выполняет вычисления, формирует ответ с ошибкой и результатом, и отправляет его обратно на сервер через POST-запрос. Если выражение вычислено корректно, поле ошибки остаётся пустым, а результат содержит значение. В противном случае, в поле ошибки будет указана ошибка, а результат будет пустым.

## Компоненты системы
### Оркестратор
Оркестратор отвечает за прием арифметических выражений, их разбиение на отдельные операции и распределение этих задач между горутинами агента для выполнения.

#### API Оркестратора
- **Добавление вычисления арифметического выражения**
```sh
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "2+2*2"
}'
```
**Ответ:**
```json
Формат:
{
    "id": <уникальный идентификатор выражения>
}

Пример:
{
    "id": "28e51dff-61ae-4c6b-8f53-661582d5820d"
}
```
*или:*
```json
{
    "error": <ошибка>
}
```

- **Получение списка выражений**
```sh
curl --location 'localhost:8080/api/v1/expressions'
```
**Ответ:**
```json
Формат:
{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
    ]
}

Пример:
{
    "expressions": [
        {
            "id": "accfe4a0-6a7b-40b3-9881-9c59020248aa",
            "status": "completed",
            "result": 87
        },
        {
            "id": "f040c38a-0c64-4332-aebd-a7124dcefa00",
            "status": "completed",
            "result": 4
        }
    ]
}
```
*или:*
```json
{
    "error": <ошибка>
}
```

- **Получение выражения по его идентификатору**
```sh
Формат:
curl --location 'localhost:8080/api/v1/expressions/:id'

Пример:
curl --location 'localhost:8080/api/v1/expressions/accfe4a0-6a7b-40b3-9881-9c59020248aa'
```
**Ответ:**
```json
Формат:
{
    "expression": {
        "id": <идентификатор выражения>,
        "status": <статус вычисления выражения>,
        "result": <результат выражения>
    }
}

Пример:
{
    "expression": {
        "id": "accfe4a0-6a7b-40b3-9881-9c59020248aa",
        "status": "completed",
        "result": 87
    }
}
```
*или:*
```json
{
    "error": <ошибка>
}
```

- **Получение задачи для выполнения**
```sh
curl --location 'localhost:8080/internal/task'
```
**Ответ:**
```json
Формат
{
    "task": {
        "id": <идентификатор задачи>,
        "arg1": <имя первого аргумента>,
        "arg2": <имя второго аргумента>,
        "operation": <операция>
    }
}
```

- **Прием результата обработки данных**
```sh
curl --location 'localhost:8080/internal/task' \
--header 'Content-Type: application/json' \
--data '{
  "id": 1,
  "result": 2.5
}'
```

---

### Агент
Агент получает задачи от оркестратора, выполняет их и отправляет обратно результаты.
Агент запускает несколько вычислительных горутин, количество которых регулируется переменной среды `COMPUTING_POWER`.

<<<<<<< HEAD
#### Примеры запросов и ответов для сервера
=======
## Примеры запросов и ответов для сервера
>>>>>>> 6dba1cbfde162d4499a314ca9963aad177b28dd2

### 1. Добавление вычисления арифметического выражения

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "2 + 2 * 2"
}'
```

**Ответ**:
```json
{
    "id": 1741187030581847400
}
```

**Код ответа**:
- 201 - выражение принято для вычисления

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "expression": "2 / 0"
}'
```

**Ответ**:
```json
{
    "error": "division by zero"
}
```

**Код ответа**:
- 422 - невалидные данные

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
  "exp":
}'
```

**Ответ**:
```json
{
    "error": "internal server error"
}
```

**Код ответа**:
- 500 - некорректный запрос

---

### 2. Получение списка выражений

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/expressions'
```

**Ответ**:
```json
{
    "expressions": [
        {
            "id": 1741187753311405100,
            "status": "in process",
            "result": ""
        },
        {
            "id": 174118775331145300,
            "status": "done",
            "result": 6.0000
        }
    ]
}
```

**Код ответ**:
- 200 - успешно получен список выражений

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/expressions'
```

**Ответ**:
```json
{
    "error":"empty base"
}
```

**Код ответ**:
- 500 - база данных пустая

---

### 3. Получение выражения по его идентификатору

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/expressions/:1741187753311405100'
```

**Ответ**:
```json
{
    "expression": {
        "id": 1741187753311405100,
        "status": "in proccess",
        "result": ""
    }
}
```

**Код ответа**:
- 200 - успешно получено выражение

**Запрос**:
```bash
curl --location 'localhost:8080/api/v1/expressions/:1741187753311643100'
```

**Ответ**:
```json
{
    "error":"no expression with id: 1741187753311643100"
}
```

**Код ответа**:
- 404 - нет такого выражения
  
## Контакты
Если у вас возникли вопросы, предложения и т.д., вот мой тг:
```
https://t.me/sigmatemik52
```
